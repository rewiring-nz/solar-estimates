# Configures a Docker Compose setup for the solar pipeline project.
# Sets up a containerized application with the necessary dependencies,
# mounts local directories for seamless development, and persists the
# GRASS database using a named volume.

# Usage:
# 1. Ensure Docker (20.10+) and Docker Compose (v2.0+) are installed on your system.
# 2. Navigate to the directory containing this file.
# 3. Run `docker compose up pipeline` to build and start the container.
# 4. Use `docker compose down` to stop and remove the container.
# 5. Run `docker compose up docs` to start the doc server at http://0.0.0.0:8000/ .
# 6. Type ^C to stop.

# Define the services (containers) you want to run
services:
  # Run this with: `docker compose up pipeline`
  pipeline:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    platform: linux/amd64
    container_name: nz_solar_pipeline
    
    # Mount local directories for seamless development and persistence
    volumes:
      # Mount the entire project root. Changes to your code are instantly reflected.
      # Local root (where docker-compose.yml is) -> Container's /app
      - .:/app
      
      # Persist the GRASS database (grassdata) using a Docker named volume.
      # GRASS data is now expected in /app/src/grassdata
      - grass_db:/app/src/grassdata
    # Pipeline arguments are passed via the env file that is specified by the --env-file flag.
    # Paths are relative to the WORKDIR /app/src defined in the Dockerfile.
    command: >
      /opt/venv/bin/python /app/src/pipeline.py
      --dsm-glob "${INPUT_DSM_GLOB}"
      --building-dir "${INPUT_BUILDING_DIR}"
      --area-name "${OUTPUT_AREA_NAME}"
      --building-layer-name "${OUTPUT_BUILDING_LAYER_NAME}"
      --grass-base "/usr/lib/grass84"

  # Run this with: `docker compose up docs`
  docs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nz_solar_docs
    ports:
      - "8000:8000"
    volumes:
      - .:/app
    # Set the working directory to the project root where mkdocs.yml lives
    working_dir: /app
    # Override the pipeline entrypoint to use mkdocs from the virtual env
    entrypoint: ["/opt/venv/bin/mkdocs"]
    command: ["serve", "-a", "0.0.0.0:8000"]

# Define named volumes for persistent data storage
volumes:
  grass_db:
    driver: local