# Configures a Docker Compose setup for the solar pipeline project.
# Sets up a containerized application with the necessary dependencies,
# mounts local directories for seamless development, and persists the
# GRASS database using a named volume.

# Usage:
# 1. Ensure Docker (20.10+) and Docker Compose (v2.0+) are installed on your system.
# 2. Navigate to the directory containing this file.
# 3. Run `docker compose up` to build and start the container.
# 4. Use `docker-compose down` to stop and remove the container.

# Define the services (containers) you want to run
services:
  # Main analysis service
  solar_pipeline:
    # Build context is the current directory, using the Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    
    platform: linux/amd64
    
    container_name: nz_solar_pipeline_dev
    
    # Mount local directories for seamless development and persistence
    volumes:
      # Mount the entire project root. Changes to your code are instantly reflected.
      # Local root (where docker-compose.yml is) -> Container's /app
      - .:/app
      
      # Persist the GRASS database (grassdata) using a Docker named volume.
      # GRASS data is now expected in /app/src/grassdata
      - grass_db:/app/src/grassdata
      
    # The command to run your pipeline.py for testing
    # Paths are now relative to the container's WORKDIR: /app/src
    command: 
      [
        "--dsm-glob", "data/shotover_country/*.tif",
        "--building-dir", "data/queenstown_lakes_building_outlines",
        "--area-name", "shotover_country",
        "--building-layer-name", "queenstown_lakes_buildings",
        # The GRASS base path is a system path, not relative to the project.
        "--grass-base", "/usr/lib/grass84",
      ]

  # Documentation service for live-previewing the web docs
  docs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nz_solar_docs_dev
    # Map the default MkDocs port to your local machine
    ports:
      - "8000:8000"
    volumes:
      - .:/app
    # Set the working directory to the project root where mkdocs.yml lives
    working_dir: /app
    # Override the ENTRYPOINT to run the MkDocs development server
    entrypoint: ["/opt/venv/bin/mkdocs"]
    command: ["serve", "-a", "0.0.0.0:8000"]

# Define named volumes for persistent data storage
volumes:
  grass_db:
    driver: local